<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ filename }} - Ariel</title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Mermaid.js -->
    <script type="module">
        import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@11.12.1/dist/mermaid.esm.min.mjs';
        mermaid.initialize({ startOnLoad: false, theme: 'default' });
        window.mermaid = mermaid;
    </script>

    <style>
        .checkerboard {
            background-image:
                linear-gradient(45deg, #ccc 25%, transparent 25%),
                linear-gradient(-45deg, #ccc 25%, transparent 25%),
                linear-gradient(45deg, transparent 75%, #ccc 75%),
                linear-gradient(-45deg, transparent 75%, #ccc 75%);
            background-size: 20px 20px;
            background-position: 0 0, 0 10px, 10px -10px, -10px 0px;
            background-color: #fff;
            min-height: 400px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px dashed #999;
        }

        body {
            margin: 0;
            padding: 0;
        }

        .page-container {
            margin: 0 10px;
        }

        .navbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid #dee2e6;
            margin-bottom: 20px;
        }

        .navbar-left,
        .navbar-right {
            font-size: 14px;
            display: flex;
            align-items: center;
        }

        .filename {
            color: #212529;
            font-weight: 500;
        }

        .status-text-nav {
            color: #6c757d;
            margin-left: 8px;
        }

        #diagram-container {
            min-height: 400px;
            padding: 20px 0;
            background: #fff;
            width: 100%;
        }

        .error-message {
            margin-top: 15px;
        }

        #status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-ok {
            background-color: #28a745;
        }

        .status-error {
            background-color: #dc3545;
        }
    </style>
</head>
<body>
    <div class="page-container">
        <div class="navbar">
            <div class="navbar-left">
                <span class="filename">{{ filename }}</span>
            </div>
            <div class="navbar-right">
                <span id="status-indicator" class="status-ok"></span>
                <span id="status-text" class="status-text-nav">Connected</span>
            </div>
        </div>

        <div>
            <div id="diagram-container">
                <div class="checkerboard">
                    <span class="text-muted">Loading diagram...</span>
                </div>
            </div>

            <div id="error-container" class="alert alert-danger error-message" style="display: none;" role="alert">
                <strong>Error:</strong> <span id="error-message"></span>
            </div>
        </div>
    </div>

    <script>
        let lastETag = null;
        let pollInterval = null;

        function showError(message) {
            const errorContainer = document.getElementById('error-container');
            const errorMessage = document.getElementById('error-message');
            const diagramContainer = document.getElementById('diagram-container');
            const statusIndicator = document.getElementById('status-indicator');
            const statusText = document.getElementById('status-text');

            errorMessage.textContent = message;
            errorContainer.style.display = 'block';
            diagramContainer.innerHTML = '<div class="checkerboard"><span class="text-muted">Error occurred</span></div>';
            statusIndicator.className = 'status-error';
            statusText.textContent = 'Error';
        }

        function clearError() {
            const errorContainer = document.getElementById('error-container');
            errorContainer.style.display = 'none';
        }

        function updateStatus(status) {
            const statusIndicator = document.getElementById('status-indicator');
            const statusText = document.getElementById('status-text');

            switch(status) {
                case 'ok':
                    statusIndicator.className = 'status-ok';
                    statusText.textContent = 'Connected';
                    break;
                case 'error':
                    statusIndicator.className = 'status-error';
                    statusText.textContent = 'Error';
                    break;
            }
        }

        async function renderDiagram(mermaidCode) {
            const diagramContainer = document.getElementById('diagram-container');

            try {
                // Save current scroll position and container height
                const scrollX = window.scrollX;
                const scrollY = window.scrollY;
                const currentHeight = diagramContainer.offsetHeight;

                // Preserve container height to prevent layout shift
                diagramContainer.style.minHeight = `${currentHeight}px`;

                // Clear previous content
                diagramContainer.innerHTML = '';

                // Create a div for mermaid to render into
                const mermaidDiv = document.createElement('div');
                mermaidDiv.className = 'mermaid';
                mermaidDiv.textContent = mermaidCode;
                diagramContainer.appendChild(mermaidDiv);

                // Render with mermaid
                await window.mermaid.run({
                    querySelector: '.mermaid',
                });

                // Remove min-height after rendering to allow natural sizing
                diagramContainer.style.minHeight = '';

                // Restore scroll position
                window.scrollTo(scrollX, scrollY);

                clearError();
                updateStatus('ok');
            } catch (error) {
                console.error('Mermaid rendering error:', error);
                showError('Failed to render diagram: ' + error.message);
            }
        }

        async function checkForUpdates() {
            try {
                const headers = {};
                if (lastETag) {
                    headers['If-None-Match'] = lastETag;
                }

                const response = await fetch('/mermaid', { headers });

                if (response.status === 304) {
                    // Not modified - keep status as is (should already be 'ok')
                    return;
                }

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();

                // Update ETag for next request
                lastETag = response.headers.get('ETag');

                // Render the new diagram
                if (data.content) {
                    await renderDiagram(data.content);
                } else {
                    throw new Error('No diagram content received');
                }

            } catch (error) {
                console.error('Error checking for updates:', error);
                showError('Failed to fetch diagram: ' + error.message);
            }
        }

        // Start polling when page loads
        document.addEventListener('DOMContentLoaded', function() {
            // Initial check
            checkForUpdates();

            // Poll every second
            pollInterval = setInterval(checkForUpdates, 1000);
        });

        // Clean up on page unload
        window.addEventListener('beforeunload', function() {
            if (pollInterval) {
                clearInterval(pollInterval);
            }
        });
    </script>
</body>
</html>
